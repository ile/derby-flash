// Generated by CoffeeScript 1.5.0
var Model, flash, racer;

racer = require('racer');

Model = racer["protected"].Model;

flash = module.exports;

flash.init = function(app) {
  var add, middleware, originalRouter, show;
  show = function() {
    var flashq, flashq2, model, msg, type, _i, _len, _ref;
    model = this.view.model;
    flashq = model.get('_flashq') || {};
    flashq2 = model.get('_flashq2') || {};
    for (type in flashq2) {
      flashq[type] || (flashq[type] = []);
      _ref = flashq2[type];
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        msg = _ref[_i];
        flashq[type].push(msg);
      }
    }
    model.set('_flash', flashq);
    model.del('_flashq');
    return model.del('_flashq2');
  };
  add = function(type, msg) {
    var _ref;
    if ((_ref = this.req) != null ? _ref.flash : void 0) {
      return this.req.flash(type, msg);
    } else {
      return this.push("_flashq." + type, msg);
    }
  };
  app.on('render', show);
  Model.prototype.flash = add;
  originalRouter = app.router;
  middleware = function(req, res, next) {
    var model;
    model = req.getModel();
    if (req.flash) {
      model.set('_flashq2', req.flash());
    }
    return (originalRouter())(req, res, next);
  };
  app.router = function() {
    return middleware;
  };
  return app;
};
